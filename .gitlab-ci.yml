###############################################
#   _____   _____ _____   _____ _____      __ #
#  / _ \ \ / / __| _ \ \ / /_ _| __\ \    / / #
# | (_) \ V /| _||   /\ V / | || _| \ \/\/ /  #
#  \___/ \_/ |___|_|_\ \_/ |___|___| \_/\_/   #
#                                             #
###############################################
#
# ASCII art generated from: http://patorjk.com/software/taag/#p=display&f=Small&t=

stages:
  - test
  - pipeline_setup
  - build
  - deploy
  - push_to_stash

variables:
  REPOSITORY_PROD_URL: "nexus-docker-hosted.gahmen.tech/mcf/svc-auth"
  REPOSITORY_URL_FOR_NECTAR: "nexus-docker-public.gds-gov.tech/mcf/svc-auth"
  GITLAB_HOSTNAME: "gitlab.gds-gov.tech"
  GIT_SSL_NO_VERIFY: "true"

#####################
#  _____       _    #
# |_   _|__ __| |_  #
#   | |/ -_|_-<  _| #
#   |_|\___/__/\__| #
#                   #
#####################

test_app:
  stage: test
  except:
    - master
    - tags
  image: govtechsg/cicd-images:dind-latest
  script:
    - ./gradlew test
  tags:
    - dind

test_bitbucket:
  stage: test
  except:
    - master
    - tags
  image: govtechsg/cicd-images:dind-latest
  script:
    - echo -e "[credential]\n  helper = store" > ~/.gitconfig
    - echo "https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@${BITBUCKET_DOMAIN}" > ~/.git-credentials
    - git clone https://${BITBUCKET_DOMAIN}/scm/ojmp/one.git nectar_one
    - rm -f ~/.git-credentials
  tags:
    - dind

#################################################################
#  ___ ___ ___ ___ _    ___ _  _ ___   ___ ___ _____ _   _ ___  #
# | _ \_ _| _ \ __| |  |_ _| \| | __| / __| __|_   _| | | | _ \ #
# |  _/| ||  _/ _|| |__ | || .` | _|  \__ \ _|  | | | |_| |  _/ #
# |_| |___|_| |___|____|___|_|\_|___| |___/___| |_|  \___/|_|   #
#                                                               #
#################################################################

version_tagging:
  stage: pipeline_setup
  image: govtechsg/cicd-images:vtscripts-latest
  only:
    - master
  except:
    - tags
  artifacts:
    paths:
      - .version
    expire_in: 1 day
  script:
    - git clone -b ${CI_COMMIT_REF_NAME} https://wsg-deploy-bot:${WSG_DEPLOY_BOT_TOKEN}@${GITLAB_HOSTNAME}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}.git ${CI_PROJECT_NAME}
    - cd ${CI_PROJECT_NAME}
    - iterate patch -q -i
    - git push origin ${CI_COMMIT_REF_NAME} --tags
    - printf -- "$(get-latest -q)-$(git rev-parse --short HEAD)" > ../.version
  tags:
    - isenmouthe

#######################
#  ___      _ _    _  #
# | _ )_  _(_) |__| | #
# | _ \ || | | / _` | #
# |___/\_,_|_|_\__,_| #
#                     #
#######################

build_container:
  stage: build
  only:
    - master
  image: govtechsg/cicd-images:dind-latest
  script:
    - mkdir ~/.docker && echo "${DOCKER_REGISTRY_JSON}" > ~/.docker/config.json
    - CURRENT_COMMIT_MESSAGE="$(git log -1 --pretty=%B)"
    - TAG=${REPOSITORY_PROD_URL}:$(cat ./.version)
    - TAG_FOR_NECTAR=${REPOSITORY_URL_FOR_NECTAR}:$(cat ./.version)
    - ./gradlew build docker -P docker_tags=${TAG};
    - docker push ${TAG};
    - docker tag ${TAG} ${TAG_FOR_NECTAR}
    - docker push ${TAG_FOR_NECTAR}
    - rm ~/.docker/config.json
    - docker rmi ${TAG}
    - docker rmi ${TAG_FOR_NECTAR}
  tags:
    - dind

#################################
#  ___  ___ ___ _    _____   __ #
# |   \| __| _ \ |  / _ \ \ / / #
# | |) | _||  _/ |_| (_) \ V /  #
# |___/|___|_| |____\___/ |_|   #
#                               #
#################################

deploy_development:
  stage: deploy
  when: on_success
  only:
    - master
  script:
    - ENV=development APP_TOKEN_PRIVATE_KEY=${APP_LOCAL_TOKEN_PRIVATE_KEY} VERSION=$(cat ./.version) ./deploy-svc-auth.sh
  tags:
    - kube

deploy_remote_development:
  stage: deploy
  when: on_success
  only:
    - master
  script:
    - ENV=remote-development VERSION=$(cat ./.version) ./deploy-svc-auth.sh
  tags:
    - kube

deploy_qa:
  stage: deploy
  when: on_success
  only:
    - master
  script:
    - ENV=qa VERSION=$(cat ./.version) ./deploy-svc-auth.sh
  tags:
    - kube

deploy_uat:
  stage: deploy
  when: on_success
  only:
    - master
  script:
    - ENV=uat VERSION=$(cat ./.version) ./deploy-svc-auth.sh
  tags:
    - kube

#######################################################
#  ___         _      _         ___ _           _     #
# | _ \_  _ __| |_   | |_ ___  / __| |_ __ _ __| |_   #
# |  _/ || (_-< ' \  |  _/ _ \ \__ \  _/ _` (_-< ' \  #
# |_|  \_,_/__/_||_|  \__\___/ |___/\__\__,_/__/_||_| #
#                                                     #
#######################################################

push_to_stash:
  stage: push_to_stash
  when: on_success
  only:
    - master
  except:
    - tags
  script:
    - echo -e "[credential]\n  helper = store" > ~/.gitconfig
    - echo "https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@${BITBUCKET_DOMAIN}" > ~/.git-credentials
    - git clone https://${BITBUCKET_DOMAIN}/scm/ojmp/one.git nectar_one
    - cd nectar_one
    - VERSION=$(cat ../.version)
    - 'sed -i "1 s/^.*/FROM nexus-docker-public.gds-gov.tech\/mcf\/svc-auth:${VERSION}/" ./backend/svc.auth.Dockerfile'
    - git add .
    - 'git commit --allow-empty -m "SP/CP svc-auth: ${VERSION}"'
    - git push
    - rm -f ~/.git-credentials
  tags:
    - primitive
